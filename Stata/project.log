-------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /afs/umich.edu/user/y/u/yuywang/project.log
  log type:  text
 opened on:   5 Dec 2019, 16:52:11

. * import data and keep and rename relevant variables
. * import total nutrient day 1 2015
. fdause DR1TOT_I.XPT, clear

. quietly compress

. gsort +seqn

. generate carb_ratio = dr1tcarb*4 / dr1tkcal
(1,218 missing values generated)

. * 0 for carb_ratio between 0.45 and 0.65
. generate carb_level = 0

. replace carb_level = 1 if carb_ratio < 0.45
(2,715 real changes made)

. replace carb_level = 2 if carb_ratio > 0.65
(1,801 real changes made)

. keep seqn carb_level

. save DR1TOT_l.dta, replace
file DR1TOT_l.dta saved

. 
. * import sleep disorder data
. fdause SLQ_I.XPT, clear

. quietly compress

. gsort +seqn

. keep seqn sld012 slq120

. * drop 'dont know' response
. drop if slq120 == 9
(5 observations deleted)

. rename sld012 sleephr

. rename slq120 sleepy

. merge 1:1 seqn using DR1TOT_l.dta

    Result                           # of obs.
    -----------------------------------------
    not matched                         3,750
        from master                       264  (_merge==1)
        from using                      3,486  (_merge==2)

    matched                             6,058  (_merge==3)
    -----------------------------------------

. drop _merge

. save DRTOT_SLP.dta, replace
file DRTOT_SLP.dta saved

. 
. * import demographic data
. fdause DEMO_I.XPT, clear

. quietly compress

. gsort +seqn

. generate winter = 0

. replace winter = 1 if ridexmon == 1
(4,594 real changes made)

. * 0 male 1 female
. generate gender = riagendr - 1

. keep seqn gender ridageyr winter

. rename ridageyr age

. merge 1:1 seqn using DRTOT_SLP.dta

    Result                           # of obs.
    -----------------------------------------
    not matched                           163
        from master                       163  (_merge==1)
        from using                          0  (_merge==2)

    matched                             9,808  (_merge==3)
    -----------------------------------------

. keep if _merge == 3
(163 observations deleted)

. drop _merge

. label define sleepiness 0 "Never" 1 "Rarely" 2 "Sometimes" 3 "Often" 4 "Almost always"

. label values sleepy sleepiness

. save DRTOT_SLP_DEMO.dta, replace
file DRTOT_SLP_DEMO.dta saved

. 
. * response: sleepy (five levels: 0-4)
. * independent variables: carb_ratio
. * control variables: gender, age, winter, sleephr
. 
. * ordered logistic regression (proportional odds assumption)
. ologit sleepy i.carb_level sleephr gender age winter

Iteration 0:   log likelihood = -9217.7885  
Iteration 1:   log likelihood = -9154.9739  
Iteration 2:   log likelihood = -9154.8854  
Iteration 3:   log likelihood = -9154.8854  

Ordered logistic regression                     Number of obs     =      6,030
                                                LR chi2(6)        =     125.81
                                                Prob > chi2       =     0.0000
Log likelihood = -9154.8854                     Pseudo R2         =     0.0068

------------------------------------------------------------------------------
      sleepy |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
  carb_level |
          1  |   .1106579   .0504731     2.19   0.028     .0117325    .2095833
          2  |  -.1502159   .0701136    -2.14   0.032    -.2876361   -.0127957
             |
     sleephr |  -.0919368   .0150983    -6.09   0.000    -.1215289   -.0623447
      gender |   .2346664    .046394     5.06   0.000     .1437358    .3255971
         age |  -.0074141   .0011957    -6.20   0.000    -.0097577   -.0050705
      winter |  -.1808318    .046178    -3.92   0.000    -.2713389   -.0903246
-------------+----------------------------------------------------------------
       /cut1 |  -2.530796   .1405631                     -2.806294   -2.255297
       /cut2 |  -1.363294   .1379162                     -1.633605   -1.092983
       /cut3 |   .0394891   .1367514                     -.2285388     .307517
       /cut4 |   1.428227   .1403242                      1.153197    1.703258
------------------------------------------------------------------------------

. 
. * intall package for brant test to check assumption
. net from http://www.indiana.edu/~jslsoc/stata/
-------------------------------------------------------------------------------------------
http://www.indiana.edu/~jslsoc/stata/
2018-05-25
-------------------------------------------------------------------------------------------

SPost:     Interpreting regression models. Scott Long & Jeremy Freese
Workflow:  Workflow of data analysis. Scott Long
Teaching:  Teaching files. Scott Long
Research:  Research examples & commands. Scott Long
Support:   www.indiana.edu/~jslsoc/spost.htm
www.indiana.edu/~jslsoc/workflow.htm

PACKAGES you could -net describe-:
    workingdir        : Commands for changing working directories and managing projects.
    doit              : Utilities for working from the Command window.
    cdanomord         : CDA regression models for nominal & ordinal outcomes.
    groupsbrm         : Comparing groups in binary regression model
    workflow          : Workflow utilities
    rrus              : Reproducible Results Using Stata 2016-06.
    rrusadvanced      : Reproducible Results Using Stata - advanced
    rrusautomate      : Reproducible Results Using Stata - automation
    matmath           : matrix routines
    matmath1          : version 1 -- matrix routines
    pathview          : Pathview programs.
    scottlong         : Scott Long unsupported programs.
    spost9_ado        : SPost 9 commands for Stata 9+.
    spost9_do         : SPost 9 sample do and dta files.
    spostado          : Stata 8 ado files for SPost.
    spostrm7          : Stata 7 examples for Long's Regression Models for CLDVs.
    spostst8          : Stata 8 examples for Reg Models for CDVs using Stata.
    spost13_ado       : SPost 13 commands for Stata 11+.
    spost9_legacy     : SPost 9 commands that work with SPost 13.
    spost13_do        : SPost 13 sample do and dta files for Stata 13+.
    spost13_do12      : SPost 13 sample do and dta files for Stata 11+.
    spost13_sage      : under development - SPost 13 examples for Long's Regression
                        Models for CLDVs.
    wf-help           : Workflow | guidelines for an effective workflow.
    wf09-part1        : Workflow | part 1 of 2 for Stata 9.
    wf09-part2        : Workflow | part 2 of 2 for Stata 9.
    wf10-part1        : Workflow | part 1 of 2 for Stata 10.
    wf10-part2        : Workflow | part 2 of 2 for Stata 10.
    eusmex2016        : Generalized marginal effects at EUSMEX 2016 Meetings.
-------------------------------------------------------------------------------------------

. net install spost13_ado
checking spost13_ado consistency and verifying not already installed...
all files already exist and are up to date.

. brant

Brant test of parallel regression assumption

               |       chi2     p>chi2      df
 --------------+------------------------------
           All |      59.70      0.000      18
 --------------+------------------------------
  1.carb_level |       5.55      0.136       3
  2.carb_level |       8.26      0.041       3
       sleephr |      12.03      0.007       3
        gender |       7.52      0.057       3
           age |       5.08      0.166       3
        winter |      17.47      0.001       3

A significant test statistic provides evidence that the parallel
regression assumption has been violated.

. 
. * assumption for ologit violated so try generalized
. ssc install gologit2
checking gologit2 consistency and verifying not already installed...
all files already exist and are up to date.

. 
. * compare between models
. quietly gologit2 sleepy i.carb_level sleephr gender age winter, store(gologit)

. * Partial Proportional Odds Model (constraints from brant test)
. quietly gologit2 sleepy i.carb_level sleephr gender age winter, store(gologit2) pl(age i.
> carb_level gender)

. quietly gologit2 sleepy i.carb_level sleephr gender age winter, store(ologit) pl

. * ologit is too restrictive
. lrtest ologit gologit

Likelihood-ratio test                                 LR chi2(18) =     56.92
(Assumption: ologit nested in gologit)                Prob > chi2 =    0.0000

. * if use significance level 0.001, partial proportional odds is not too restrictive
. lrtest gologit gologit2

Likelihood-ratio test                                 LR chi2(12) =     31.73
(Assumption: gologit2 nested in gologit)              Prob > chi2 =    0.0015

. 
. * model we chose
. quietly gologit2 sleepy i.carb_level sleephr gender age winter, store(gologit2) pl(age i.
> carb_level gender)

. 
. * coefficient table
. esttab gologit2, wide label title(Rgression Table for Partial Proportional Odds Model) ad
> dnote("Source: DRTOT_SLP_DEMO.dta")

Rgression Table for Partial Proportional Odds Model
-------------------------------------------------
                              (1)                
                     How often ~r                
-------------------------------------------------
Never                                            
carb_level=0                    0             (.)
carb_level=1                0.113*         (2.24)
carb_level=2               -0.151*        (-2.15)
Sleep hours               -0.0581*        (-2.56)
gender                      0.234***       (5.04)
Age in years at sc~g     -0.00740***      (-6.18)
winter                     -0.376***      (-5.55)
Constant                    2.371***      (12.22)
-------------------------------------------------
Rarely                                           
carb_level=0                    0             (.)
carb_level=1                0.113*         (2.24)
carb_level=2               -0.151*        (-2.15)
Sleep hours               -0.0740***      (-4.24)
gender                      0.234***       (5.04)
Age in years at sc~g     -0.00740***      (-6.18)
winter                     -0.184***      (-3.48)
Constant                    1.224***       (7.94)
-------------------------------------------------
Sometimes                                        
carb_level=0                    0             (.)
carb_level=1                0.113*         (2.24)
carb_level=2               -0.151*        (-2.15)
Sleep hours                -0.120***      (-6.34)
gender                      0.234***       (5.04)
Age in years at sc~g     -0.00740***      (-6.18)
winter                    -0.0960         (-1.63)
Constant                    0.132          (0.81)
-------------------------------------------------
Often                                            
carb_level=0                    0             (.)
carb_level=1                0.113*         (2.24)
carb_level=2               -0.151*        (-2.15)
Sleep hours                -0.142***      (-5.03)
gender                      0.234***       (5.04)
Age in years at sc~g     -0.00740***      (-6.18)
winter                     0.0111          (0.12)
Constant                   -1.145***      (-5.02)
-------------------------------------------------
Observations                 6030                
-------------------------------------------------
t statistics in parentheses
Source: DRTOT_SLP_DEMO.dta
* p<0.05, ** p<0.01, *** p<0.001

. 
. * marginal effect for carb_level
. mtable, dydx(carb_level)

Expression: Marginal effect of Pr(sleepy), predict(outcome())

           |    Never    Rarely  Sometimes     Often  Almost always
 ----------+-------------------------------------------------------
         1 |   -0.016    -0.011      0.005     0.013          0.009
         2 |    0.023     0.013     -0.009    -0.017         -0.010

Specified values where .n indicates no values specified with at()

           |  No at()
 ----------+---------
   Current |       .n

. 
. 
. log close
      name:  <unnamed>
       log:  /afs/umich.edu/user/y/u/yuywang/project.log
  log type:  text
 closed on:   5 Dec 2019, 16:52:59
-------------------------------------------------------------------------------------------
