---
title: "Stats 506: Group Project"
author: "Yehao Zhang"
group number: "6"
date: "December 11, 2019"
output: html_document
---
## Method

In this project, we select ordinal logistic regression as our main analysis approach because the response variable, the CHO level, is categorical and ordinal, which means there is an ordering in the categories. A simple logistic regression model assumes there is no ordering in the response variable and the log of odds that an event occurs is simply a linear combination of the independent variables.
However, ordinal logistic regression can overcome this limitation by using cumulative events for the log of the odds computations. Let $Y$ be an ordinal outcome with i categories. Then $P(Y<j)$ is the cumulative probability of $Y$ less than or equal to a specific category $i = 1,...,i-1$. The odds of being less than or equal to this category can be defined as 
\[
%
\frac{P(Y\leq i)}{P(Y>i)}\ \textrm{for} \ i=1,...,i-1.
%
\]

And the log odds is defines as 
\[
%
log\frac{P(Y\leq i)}{P(Y>i)} 
%
\]

The ordinal logistic regression model is defined as
\[
%
\frac{P(Y\leq i)}{P(Y>i)} = \beta_{i0}-\beta_1x_1-...-\beta_jx_j
%
\]
where $x_1,...x_j$ are the independent variables.

## Core Analysis 

As discussed in the data section, we first perform data cleaning on each dataset and merge them into one. Finally, the rows that contain NAs are removed.

```{r}

## import useful packages
library(tidyverse)
library(data.table)
library(foreign)
library(MASS)

```


```{r}

## Data

# Import data
sleep_disorder <- setDT(read.xport("SLQ_I.XPT"))
tot_nutrition_d1 <-setDT(read.xport("DR1TOT_I.XPT"))
demo <- setDT(read.xport("DEMO_I.XPT"))

# Data cleaning
sleep_disorder = sleep_disorder[SLQ120 <= 4, .(respondent_ID = SEQN, sleep_hr = SLD012, sleepy_freq = factor(SLQ120,))]

tot_nutrition = tot_nutrition_d1[, .(respondent_ID = SEQN, energy = DR1TKCAL, CHO = DR1TCARB)
                                ][, .(p_CHO = CHO*4/energy), by = respondent_ID
                                ][, CHO_level := "suggested range"
                                ][p_CHO <= 0.45, CHO_level := "below range(<=0.45)" 
                                ][p_CHO >= 0.65, CHO_level := "above range(>=0.65)"
                                ][, CHO_level := factor(CHO_level)
                                ]

demo = demo[RIDAGEYR >= 5, .(respondent_ID = SEQN, six_month = factor(RIDEXMON), gender = factor(RIAGENDR), age = RIDAGEYR)]

# Merge these three datasets
sleep = merge(sleep_disorder, tot_nutrition, by = "respondent_ID") %>%
  merge(. , demo, by = "respondent_ID") %>%
  na.omit(.)

sleep # the cleaned data

```

### Model Assumption
In the next step, we need to assess whether the ordinal regression is appropriate for this analysis.


Now the dataset "sleep" is ready to fit the ordered logistic regression model.

```{r}

# fit ordered logit model 
m <- polr(sleepy_freq ~ sleep_hr + CHO_level + six_month + gender + age, data = sleep, Hess = TRUE)

# view a summary of the model
summary(m)

```


Next, the p-values are calculated by comparing the t-value against the standard normal distribution. The 95% CI for the parameter estimates could be obtained using the "confint" function.

```{r}

# store the coefficientts
mcoef <- coef(summary(m))

# calculate p values
p <- pnorm(abs(mcoef[, "t value"]), lower.tail = FALSE) *2
mcoef = cbind(mcoef, "pvalue" = p)
mcoef

# 95% CI
(ci <- confint(m))

```


Since the coefficients from the model is difficult to interpret because they are scaled interms of logs. We could convert them into odds ratios.

```{r}

# odds ratios
exp(coef(m))

# odds ratios & CI
ci = exp(cbind(OR = coef(m), ci))
ci

```


